name: ğŸ”„ PR Validation

on:
  pull_request:
    branches: [main, develop]

concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  issues: write
  
jobs:
  quick-validation:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ğŸ“¦ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
          run_install: false

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run linting
        run: pnpm lint

      - name: ğŸ—ï¸ Build packages
        run: pnpm build:all

      - name: ğŸ§ª Run unit tests
        run: |
          pnpm --filter astro-prometheus-node-integration test -- --run
          pnpm --filter astro-opentelemetry-integration test -- --run

  e2e-prometheus-pr:
    name: ğŸ§ª Prometheus E2E (PR)
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ğŸ“¦ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
          run_install: false

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build packages
        run: pnpm build:all

      - name: ğŸ­ Install Playwright browsers
        run: pnpx playwright install --with-deps

      - name: ğŸ§ª Run Prometheus E2E tests
        run: pnpm test:e2e:ci
        working-directory: playgrounds/prometheus

  e2e-otel-pr:
    name: ğŸ§ª OpenTelemetry E2E (PR)
    runs-on: ubuntu-latest
    needs: quick-validation
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ğŸ“¦ Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
          run_install: false

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build packages
        run: pnpm build:all

      - name: ğŸ­ Install Playwright browsers
        run: pnpx playwright install --with-deps

      - name: ğŸ§ª Run OpenTelemetry E2E tests
        run: pnpm test:e2e:ci
        working-directory: playgrounds/otel

  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [e2e-prometheus-pr, e2e-otel-pr]
    if: always()
    steps:
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prometheusStatus = '${{ needs.e2e-prometheus-pr.result }}';
            const otelStatus = '${{ needs.e2e-otel-pr.result }}';
            
            let comment = '## ğŸ§ª E2E Test Results\n\n';
            
            // Prometheus results
            if (prometheusStatus === 'success') {
              comment += 'âœ… **Prometheus Integration**: All tests passed\n';
            } else {
              comment += 'âŒ **Prometheus Integration**: Tests failed\n';
            }
            
            // OpenTelemetry results
            if (otelStatus === 'success') {
              comment += 'âœ… **OpenTelemetry Integration**: All tests passed\n';
            } else {
              comment += 'âŒ **OpenTelemetry Integration**: Tests failed\n';
            }
            
            comment += '\n### ğŸ“Š Test Coverage\n';
            comment += '- **Prometheus**: OpenMetrics format, integration functionality, standalone metrics\n';
            comment += '- **OpenTelemetry**: Prometheus preset, HTTP mock-server, gRPC mock-server\n';
            
            if (prometheusStatus === 'success' && otelStatus === 'success') {
              comment += '\nğŸ‰ **All E2E tests passed!** Ready for review.';
            } else {
              comment += '\nâš ï¸ **Some tests failed.** Please check the Actions tab for details.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
